generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

model User {
  id                  Int                @id @default(autoincrement())
  email               String             @unique
  password            String
  name                String
  profilePicture      String?            @db.Text
  sign                String?            @db.Text
  roleId              Int
  status              String             @default("PENDING")
  verificationToken   String?            @db.Text
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  balanceChanges      BalanceAuditLog[]  @relation("BalanceChanges")
  documents           Document[]         @relation("UploadedDocuments")
  notes               Note[]             @relation("UserNotes")
  signatureRequests   SignatureRequest[] @relation("SignerRequests")
  assignedTasks       Task[]             @relation("AssignedTasks")
  ownedTaskLists      TaskList[]         @relation("OwnedTaskLists")
  taskListMemberships TaskListMember[]   @relation("TaskListMemberships")
  transactions        Transaction[]      @relation("CreatedTransactions")
  createdForms        Form[]             @relation("CreatedForms")
  formResponses       FormResponse[]     @relation("UserFormResponses")
  role                Role               @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId], map: "User_roleId_fkey")
}

model Form {
  id          String         @id @default(uuid())
  title       String
  description String?        @db.Text
  slug        String         @unique
  schema      Json
  isActive    Boolean        @default(true)
  settings    Json?
  createdById Int
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   User           @relation("CreatedForms", fields: [createdById], references: [id], onDelete: Cascade)
  responses   FormResponse[]

  @@index([createdById], map: "Form_createdById_fkey")
}

model FormResponse {
  id          String   @id @default(uuid())
  formId      String
  userId      Int?
  guestName   String?
  data        Json
  ipAddress   String?
  userAgent   String?  @db.Text
  submittedAt DateTime @default(now())
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  user        User?    @relation("UserFormResponses", fields: [userId], references: [id], onDelete: SetNull)

  @@index([formId], map: "FormResponse_formId_fkey")
  @@index([userId], map: "FormResponse_userId_fkey")
}

model Transaction {
  id          Int      @id @default(autoincrement())
  type        String
  amount      Float
  description String   @db.Text
  category    String
  proofImage  String?  @db.Text
  date        DateTime
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation("CreatedTransactions", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById], map: "Transaction_createdById_fkey")
}

model Document {
  id          Int                @id @default(autoincrement())
  title       String
  filePath    String             @db.Text
  checksum    String             @unique
  uploaderId  Int
  deletedAt   DateTime?
  deletedById Int?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  uploader    User               @relation("UploadedDocuments", fields: [uploaderId], references: [id], onDelete: Cascade)
  hash        DocumentHash?
  requests    SignatureRequest[]

  @@index([uploaderId], map: "Document_uploaderId_fkey")
}

model DocumentHash {
  id            Int      @id @default(autoincrement())
  documentId    Int      @unique
  originalHash  String
  signedHash    String?
  signatureData String?  @db.Text
  algorithm     String   @default("SHA256")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model SignatureRequest {
  id         Int       @id @default(autoincrement())
  documentId Int
  signerId   Int
  status     String    @default("PENDING")
  isSigned   Boolean   @default(false)
  x          Float
  y          Float
  page       Int
  type       String    @default("signature")
  text       String?   @db.Text
  width      Float?
  height     Float?
  fontSize   Float?
  signedAt   DateTime?
  rejectedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  signer     User      @relation("SignerRequests", fields: [signerId], references: [id], onDelete: Cascade)

  @@index([documentId], map: "SignatureRequest_documentId_fkey")
  @@index([signerId], map: "SignatureRequest_signerId_fkey")
}

model FinanceSettings {
  id             Int      @id @default(autoincrement())
  initialBalance Float    @default(0)
  balanceDate    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BalanceAuditLog {
  id          Int      @id @default(autoincrement())
  oldBalance  Float
  newBalance  Float
  oldDate     DateTime
  newDate     DateTime
  changedById Int
  changedAt   DateTime @default(now())
  changedBy   User     @relation("BalanceChanges", fields: [changedById], references: [id], onDelete: Cascade)

  @@index([changedById], map: "BalanceAuditLog_changedById_fkey")
}

model TaskList {
  id          Int              @id @default(autoincrement())
  name        String           @db.VarChar(255)
  description String?          @db.Text
  ownerId     Int
  createdAt   DateTime?        @default(now()) @db.DateTime(0)
  updatedAt   DateTime?        @default(now()) @updatedAt @db.DateTime(0)
  tasks       Task[]
  owner       User             @relation("OwnedTaskLists", fields: [ownerId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "TaskList_ibfk_1")
  members     TaskListMember[]

  @@index([ownerId], map: "ownerId")
}

model TaskListMember {
  id         Int       @id @default(autoincrement())
  taskListId Int
  userId     Int
  permission String?   @default("EDITOR") @db.VarChar(50)
  invitedAt  DateTime? @default(now()) @db.DateTime(0)
  taskList   TaskList  @relation(fields: [taskListId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "TaskListMember_ibfk_1")
  user       User      @relation("TaskListMemberships", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "TaskListMember_ibfk_2")

  @@unique([taskListId, userId], map: "unique_member")
  @@index([userId], map: "userId")
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String
  description String?   @db.Text
  status      String    @default("PENDING")
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  category    String?
  completedAt DateTime?
  dueDate     DateTime?
  priority    String    @default("MEDIUM")
  taskListId  Int
  assigneeId  Int?
  taskList    TaskList  @relation(fields: [taskListId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "Task_ibfk_1")
  assignee    User?     @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: Restrict, onUpdate: Restrict, map: "Task_ibfk_2")

  @@index([assigneeId], map: "assigneeId")
  @@index([taskListId], map: "taskListId")
}

model Note {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String   @default("Untitled")
  content   String?  @db.LongText
  color     String   @default("default")
  isPinned  Boolean  @default(false)
  coverImage String? @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Note_userId_fkey")
}
